<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèúÔ∏è Dune Rush - Real Multiplayer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: #fff;
      overflow-x: hidden;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; text-align: center; }

    .title {
      color: #FFD700;
      text-shadow: 0 0 20px #FF8C00;
      margin: 40px 0;
      animation: fadeIn 1s;
    }
    .title h1 { font-size: 3em; letter-spacing: 5px; }

    button {
      background: linear-gradient(135deg, #FFD700, #FF8C00);
      color: #000;
      border: none;
      padding: 20px 40px;
      font-size: 1.3em;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      margin: 10px;
      transition: all 0.3s;
    }
    button:hover { transform: scale(1.05); box-shadow: 0 5px 20px rgba(255,140,0,0.5); }

    /* Region Selection */
    .regions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }

    .region-card {
      background: linear-gradient(135deg, rgba(139,69,19,0.5), rgba(101,67,33,0.5));
      border: 3px solid #654321;
      border-radius: 15px;
      padding: 30px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .region-card:hover {
      transform: translateY(-5px);
      border-color: #FFD700;
      box-shadow: 0 10px 30px rgba(255,215,0,0.3);
    }

    .region-card h2 { color: #FFD700; font-size: 2em; margin-bottom: 15px; }
    .region-card p { color: #FFF; font-size: 1.1em; margin: 8px 0; }

    /* Lobby */
    .lobby {
      background: rgba(0,0,0,0.8);
      border: 3px solid #FFD700;
      border-radius: 15px;
      padding: 30px;
      margin: 20px 0;
      display: none;
    }

    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .player-card {
      background: rgba(139,69,19,0.4);
      border: 2px solid #654321;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }

    .player-card.ready {
      border-color: #32CD32;
      box-shadow: 0 0 15px rgba(50,205,50,0.5);
    }

    /* Race View */
    .race-view {
      display: none;
      position: relative;
    }

    .race-viewport {
      width: 100%;
      height: 70vh;
      border: 4px solid #FF8C00;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      background: #000;
    }

    canvas { position: absolute; top: 0; left: 0; }

    .ui-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 10;
      pointer-events: none;
    }

    .player-tag {
      background: rgba(0,0,0,0.8);
      border: 2px solid #FFD700;
      border-radius: 20px;
      padding: 10px 20px;
      display: inline-block;
      font-size: 1.1em;
      margin-bottom: 10px;
    }

    .live-positions {
      background: rgba(0,0,0,0.9);
      border: 2px solid #FFD700;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      max-height: 200px;
      overflow-y: auto;
    }

    .position-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      margin: 5px 0;
      background: rgba(139,69,19,0.3);
      border-radius: 5px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">
      <h1>üèúÔ∏è DUNE RUSH</h1>
      <p style="font-size: 1.3em; color: #FF8C00;">Real Multiplayer Racing</p>
    </div>

    <!-- Region Selection -->
    <div id="regionSelect" class="regions">
      <div class="region-card" onclick="joinRegion('canyon')">
        <h2>üèîÔ∏è CANYON RUN</h2>
        <p>üìè 5km race</p>
        <p>üåÑ Mountain valleys</p>
        <p>‚ö° Quick race</p>
        <p style="color: #32CD32; margin-top: 10px;">üë• <span id="canyon-count">0</span> players</p>
      </div>

      <div class="region-card" onclick="joinRegion('desert')">
        <h2>üèúÔ∏è DESERT CROSSING</h2>
        <p>üìè 15km race</p>
        <p>üåÖ Epic dunes</p>
        <p>‚ö° Medium race</p>
        <p style="color: #32CD32; margin-top: 10px;">üë• <span id="desert-count">0</span> players</p>
      </div>

      <div class="region-card" onclick="joinRegion('mountain')">
        <h2>‚õ∞Ô∏è MOUNTAIN PASS</h2>
        <p>üìè 30km race</p>
        <p>üèîÔ∏è Tall peaks</p>
        <p>‚ö° Epic marathon</p>
        <p style="color: #32CD32; margin-top: 10px;">üë• <span id="mountain-count">0</span> players</p>
      </div>
    </div>

    <!-- Lobby -->
    <div id="lobby" class="lobby">
      <h2 style="color: #FFD700; font-size: 2em; margin-bottom: 20px;">
        üèÅ RACE LOBBY
      </h2>
      <p style="color: #FF8C00; font-size: 1.2em; margin-bottom: 20px;">
        Waiting for players... (<span id="playerCount">0</span>/8)
      </p>

      <div class="players-grid" id="playersGrid"></div>

      <button onclick="toggleReady()" id="readyBtn">‚è±Ô∏è READY UP</button>
      <button onclick="backToRegions()" style="background: linear-gradient(135deg, #666, #444);">‚Üê Back</button>
    </div>

    <!-- Race View -->
    <div id="raceView" class="race-view">
      <div class="race-viewport" id="viewport">
        <canvas id="raceCanvas"></canvas>
        <div class="ui-overlay">
          <div class="player-tag">
            üéØ YOU: <span id="yourCamel"></span>
          </div>
        </div>
      </div>

      <div class="live-positions">
        <h3 style="color: #FFD700; margin-bottom: 10px;">üèÜ LIVE POSITIONS</h3>
        <div id="positionsList"></div>
      </div>

      <div id="raceResult" style="display: none; margin: 20px 0;">
        <h2 id="resultText" style="color: #FFD700; font-size: 2em;"></h2>
        <button onclick="location.reload()">üîÑ NEW RACE</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // SUPABASE
    const SUPABASE_URL = "https://itxbzfwtutozegelbwwt.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0eGJ6Znd0dXRvemVnZWxid3d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDg2NDcsImV4cCI6MjA3ODMyNDY0N30._1Oy-uaTvFxusKiooj2Pta7rYp_EOkor9wnfWQfWe7I";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // GAME STATE
    const GameState = {
      playerName: 'Player' + Math.floor(Math.random() * 10000),
      currentRegion: null,
      currentLobbyId: null,
      isReady: false,
      myCamel: null,
      otherPlayers: []
    };

    // CAMELS - COMPLETELY RANDOM EACH RACE!
    const CAMELS = [
      { id: 0, name: 'Desert Storm', color: '#8B4513', jockey: 'üë≥' },
      { id: 1, name: 'Sand Runner', color: '#D2691E', jockey: 'üßî' },
      { id: 2, name: 'Golden Wind', color: '#DAA520', jockey: 'üë®' },
      { id: 3, name: 'Oasis King', color: '#CD853F', jockey: 'üßë' },
      { id: 4, name: 'Dune Dancer', color: '#DEB887', jockey: 'üë¥' },
      { id: 5, name: 'Mirage Master', color: '#F4A460', jockey: 'üßì' },
      { id: 6, name: 'Swift Sands', color: '#BC8F8F', jockey: 'üë≤' },
      { id: 7, name: 'Thunder Hoof', color: '#A0522D', jockey: 'üßï' },
      { id: 8, name: 'Lightning Bolt', color: '#D2B48C', jockey: 'üë±' }
    ];

    // REGIONS CONFIG
    const REGIONS = {
      canyon: { name: 'Canyon Run', length: 5000, emoji: 'üèîÔ∏è' },
      desert: { name: 'Desert Crossing', length: 15000, emoji: 'üèúÔ∏è' },
      mountain: { name: 'Mountain Pass', length: 30000, emoji: '‚õ∞Ô∏è' }
    };

    // JOIN REGION
    async function joinRegion(region) {
      GameState.currentRegion = region;

      // Find or create lobby
      let { data: lobbies } = await supabase
        .from('race_lobbies')
        .select('*')
        .eq('region', region)
        .eq('status', 'waiting')
        .limit(1);

      let lobbyId;
      if (lobbies && lobbies.length > 0) {
        lobbyId = lobbies[0].id;
      } else {
        const { data: newLobby } = await supabase
          .from('race_lobbies')
          .insert([{
            region,
            race_length: REGIONS[region].length,
            status: 'waiting'
          }])
          .select()
          .single();
        lobbyId = newLobby.id;
      }

      GameState.currentLobbyId = lobbyId;

      // Assign random camel
      const randomCamel = CAMELS[Math.floor(Math.random() * CAMELS.length)];
      GameState.myCamel = randomCamel;

      // Join lobby
      await supabase
        .from('race_participants')
        .insert([{
          lobby_id: lobbyId,
          player_name: GameState.playerName,
          camel_id: randomCamel.id,
          camel_name: randomCamel.name
        }]);

      // Show lobby
      document.getElementById('regionSelect').style.display = 'none';
      document.getElementById('lobby').style.display = 'block';

      subscribeLobby(lobbyId);
      loadLobbyPlayers(lobbyId);
    }

    // SUBSCRIBE TO LOBBY UPDATES
    function subscribeLobby(lobbyId) {
      supabase.channel(`lobby:${lobbyId}`)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'race_participants',
          filter: `lobby_id=eq.${lobbyId}`
        }, () => {
          loadLobbyPlayers(lobbyId);
        })
        .subscribe();
    }

    // LOAD LOBBY PLAYERS
    async function loadLobbyPlayers(lobbyId) {
      const { data: players } = await supabase
        .from('race_participants')
        .select('*')
        .eq('lobby_id', lobbyId);

      document.getElementById('playerCount').textContent = players.length;

      const grid = document.getElementById('playersGrid');
      grid.innerHTML = players.map(p => `
        <div class="player-card">
          <div style="font-size: 2em;">${CAMELS[p.camel_id].jockey}</div>
          <strong style="color: #FFD700;">${p.player_name}</strong>
          <div style="color: #aaa; font-size: 0.9em;">${p.camel_name}</div>
        </div>
      `).join('');

      // Check if ready to start
      if (players.length >= 2 && players.every(p => p.ready)) {
        setTimeout(() => startRace(lobbyId), 2000);
      }
    }

    // TOGGLE READY
    async function toggleReady() {
      GameState.isReady = !GameState.isReady;

      await supabase
        .from('race_participants')
        .update({ ready: GameState.isReady })
        .eq('lobby_id', GameState.currentLobbyId)
        .eq('player_name', GameState.playerName);

      document.getElementById('readyBtn').textContent = GameState.isReady ? '‚úÖ READY!' : '‚è±Ô∏è READY UP';
    }

    function backToRegions() {
      location.reload();
    }

    // START RACE
    async function startRace(lobbyId) {
      await supabase
        .from('race_lobbies')
        .update({ status: 'racing' })
        .eq('id', lobbyId);

      const { data: players } = await supabase
        .from('race_participants')
        .select('*')
        .eq('lobby_id', lobbyId);

      GameState.otherPlayers = players;

      document.getElementById('lobby').style.display = 'none';
      document.getElementById('raceView').style.display = 'block';

      document.getElementById('yourCamel').textContent =
        `${GameState.myCamel.jockey} ${GameState.myCamel.name}`;

      RaceEngine.init(lobbyId, players);
    }

    // RACE ENGINE
    const RaceEngine = {
      canvas: null,
      ctx: null,
      viewport: null,
      lobbyId: null,
      camels: [],
      myCamel: null,
      raceLength: 5000,
      cameraX: 0,
      lastUpdate: 0,
      running: false,

      init(lobbyId, players) {
        this.lobbyId = lobbyId;
        this.raceLength = REGIONS[GameState.currentRegion].length;
        this.viewport = document.getElementById('viewport');
        this.canvas = document.getElementById('raceCanvas');
        this.canvas.width = this.raceLength + 2000;
        this.canvas.height = this.viewport.clientHeight;
        this.ctx = this.canvas.getContext('2d');

        // Initialize camels with TRULY RANDOM stats each race
        this.camels = players.map((p, i) => {
          const camel = CAMELS[p.camel_id];
          return {
            ...camel,
            playerName: p.player_name,
            x: 100,
            y: 100 + (i * 70),
            distance: 0,

            // COMPLETELY RANDOM - NO BIAS!
            speed: 3 + Math.random() * 2, // 3-5 random each frame
            form: Math.random(), // 0-1 completely random
            stamina: 100,
            staminaDrain: 0.02 + Math.random() * 0.03,
            burstChance: Math.random() * 0.02,
            stumbleChance: Math.random() * 0.01,
            isMe: p.player_name === GameState.playerName
          };
        });

        this.myCamel = this.camels.find(c => c.isMe);
        this.running = true;
        this.lastUpdate = performance.now();
        this.animate();
      },

      drawScene() {
        const ctx = this.ctx;
        const canvas = this.canvas;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Sky - gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height * 0.5);
        gradient.addColorStop(0, '#87CEEB');
        gradient.addColorStop(0.5, '#B0E0E6');
        gradient.addColorStop(1, '#F4A460');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height * 0.5);

        // Mountains in background
        ctx.fillStyle = '#8B7355';
        for (let i = 0; i < 10; i++) {
          const x = i * 800;
          ctx.beginPath();
          ctx.moveTo(x, canvas.height * 0.5);
          ctx.lineTo(x + 400, 50);
          ctx.lineTo(x + 800, canvas.height * 0.5);
          ctx.closePath();
          ctx.fill();
        }

        // Snow peaks
        ctx.fillStyle = '#FFF';
        for (let i = 0; i < 10; i++) {
          const x = i * 800;
          ctx.beginPath();
          ctx.moveTo(x + 300, 150);
          ctx.lineTo(x + 400, 50);
          ctx.lineTo(x + 500, 150);
          ctx.closePath();
          ctx.fill();
        }

        // Ground - natural terrain
        ctx.fillStyle = '#D2691E';
        ctx.fillRect(0, canvas.height * 0.5, canvas.width, canvas.height * 0.5);

        // Rocky ground texture
        for (let i = 0; i < 100; i++) {
          ctx.fillStyle = 'rgba(139, 69, 19, 0.3)';
          ctx.beginPath();
          ctx.arc(Math.random() * canvas.width,
                  canvas.height * 0.5 + Math.random() * (canvas.height * 0.5),
                  3 + Math.random() * 5, 0, Math.PI * 2);
          ctx.fill();
        }

        // Distance markers
        for (let i = 0; i <= this.raceLength; i += 1000) {
          const x = 100 + i;
          ctx.fillStyle = 'rgba(255,215,0,0.5)';
          ctx.fillRect(x, 0, 3, canvas.height);
          ctx.fillStyle = '#FFD700';
          ctx.font = 'bold 20px Courier';
          ctx.fillText(`${(i/1000).toFixed(0)}km`, x + 10, 40);
        }

        // Finish line
        const finishX = 100 + this.raceLength;
        ctx.fillStyle = '#000';
        ctx.fillRect(finishX, 0, 80, canvas.height);
        for (let i = 0; i < 20; i++) {
          for (let j = 0; j < 2; j++) {
            if ((i + j) % 2 === 0) {
              ctx.fillStyle = '#fff';
              ctx.fillRect(finishX + (j * 40), i * (canvas.height/20), 40, canvas.height/20);
            }
          }
        }
      },

      drawCamel(camel) {
        const ctx = this.ctx;
        const x = 100 + camel.distance;
        const y = camel.y;

        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.beginPath();
        ctx.ellipse(x + 40, y + 65, 45, 12, 0, 0, Math.PI * 2);
        ctx.fill();

        // Camel body - BIGGER AND SMOOTHER
        ctx.fillStyle = camel.color;

        // Body
        ctx.beginPath();
        ctx.ellipse(x + 40, y + 30, 50, 25, 0, 0, Math.PI * 2);
        ctx.fill();

        // Neck
        ctx.beginPath();
        ctx.ellipse(x + 70, y + 10, 15, 30, 0.3, 0, Math.PI * 2);
        ctx.fill();

        // Head
        ctx.beginPath();
        ctx.ellipse(x + 80, y - 5, 12, 15, 0.2, 0, Math.PI * 2);
        ctx.fill();

        // Humps
        ctx.beginPath();
        ctx.arc(x + 30, y + 15, 18, Math.PI, 0);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(x + 55, y + 15, 14, Math.PI, 0);
        ctx.fill();

        // Legs - animated
        const legMove = Math.sin(camel.distance * 0.1) * 5;
        ctx.fillRect(x + 15, y + 50, 8, 25 + legMove);
        ctx.fillRect(x + 35, y + 50, 8, 25 - legMove);
        ctx.fillRect(x + 55, y + 50, 8, 25 - legMove);
        ctx.fillRect(x + 75, y + 50, 8, 25 + legMove);

        // Jockey
        ctx.font = '40px Arial';
        ctx.fillText(camel.jockey, x + 35, y + 35);

        // Player indicator
        if (camel.isMe) {
          ctx.strokeStyle = '#FFD700';
          ctx.lineWidth = 5;
          ctx.strokeRect(x - 10, y - 30, 100, 110);
          ctx.fillStyle = '#FFD700';
          ctx.font = 'bold 16px Courier';
          ctx.fillText('‚≠ê YOU', x + 15, y - 35);
        }

        // Name
        ctx.fillStyle = '#FFF';
        ctx.font = 'bold 14px Courier';
        ctx.fillText(camel.playerName, x, y - 15);
      },

      animate() {
        if (!this.running) return;

        const now = performance.now();
        const delta = (now - this.lastUpdate) / 16.67; // Normalize to 60fps
        this.lastUpdate = now;

        this.drawScene();

        let winner = null;

        this.camels.forEach(camel => {
          // COMPLETELY RANDOM SPEED EACH FRAME!
          const randomSpeed = 2 + Math.random() * 3; // 2-5 completely random
          const formFactor = 0.8 + (Math.random() * 0.4); // 0.8-1.2 random
          const staminaFactor = Math.max(0.7, camel.stamina / 100);

          camel.speed = randomSpeed * formFactor * staminaFactor * delta;

          // Random events
          if (Math.random() < 0.01) camel.speed *= 1.8; // Burst
          if (Math.random() < 0.005) camel.speed *= 0.3; // Stumble

          camel.stamina -= camel.staminaDrain;
          camel.stamina = Math.max(10, camel.stamina);

          camel.distance += camel.speed;

          this.drawCamel(camel);

          if (camel.distance >= this.raceLength && !winner) {
            winner = camel;
          }
        });

        // Camera follows player
        this.cameraX = Math.max(0, this.myCamel.distance - (this.viewport.clientWidth / 3));
        this.canvas.style.transform = `translateX(-${this.cameraX}px)`;

        // Update positions
        this.updatePositions();

        if (winner) {
          this.finishRace(winner);
        } else {
          requestAnimationFrame(() => this.animate());
        }
      },

      updatePositions() {
        const sorted = [...this.camels].sort((a, b) => b.distance - a.distance);
        const list = document.getElementById('positionsList');

        list.innerHTML = sorted.map((c, i) => {
          const progress = ((c.distance / this.raceLength) * 100).toFixed(1);
          return `
            <div class="position-item" style="${c.isMe ? 'border-left: 3px solid #FFD700;' : ''}">
              <span>${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i+1}.`} ${c.playerName}</span>
              <span style="color: #32CD32;">${progress}%</span>
            </div>
          `;
        }).join('');
      },

      finishRace(winner) {
        this.running = false;

        const sorted = [...this.camels].sort((a, b) => b.distance - a.distance);
        const myPos = sorted.findIndex(c => c.isMe) + 1;

        let msg = `üèÜ ${winner.playerName} WINS!`;
        if (winner.isMe) {
          msg = 'üèÜ YOU WON! üèÜ';
        } else if (myPos === 2) {
          msg = 'ü•à 2nd Place!';
        } else if (myPos === 3) {
          msg = 'ü•â 3rd Place!';
        } else {
          msg = `Position ${myPos}/${this.camels.length}`;
        }

        document.getElementById('resultText').textContent = msg;
        document.getElementById('raceResult').style.display = 'block';
      }
    };

    // Update player counts
    setInterval(async () => {
      for (const region in REGIONS) {
        const { data: lobbies } = await supabase
          .from('race_lobbies')
          .select('id')
          .eq('region', region)
          .eq('status', 'waiting');

        let count = 0;
        if (lobbies) {
          for (const lobby of lobbies) {
            const { data: players } = await supabase
              .from('race_participants')
              .select('id')
              .eq('lobby_id', lobby.id);
            count += players ? players.length : 0;
          }
        }

        const el = document.getElementById(`${region}-count`);
        if (el) el.textContent = count;
      }
    }, 3000);
  </script>
</body>
</html>

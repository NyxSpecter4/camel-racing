<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèúÔ∏è DUNE RUSH - Multiplayer Racing MMORPG</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: #fff;
      overflow-x: hidden;
    }

    .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

    /* Epic Header */
    .header {
      background: linear-gradient(135deg, rgba(255, 140, 0, 0.2), rgba(255, 69, 0, 0.2));
      border: 3px solid #FF8C00;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 30px rgba(255, 140, 0, 0.3);
    }

    .title h1 {
      color: #FFD700;
      font-size: 3em;
      text-shadow: 0 0 20px #FF8C00;
      letter-spacing: 3px;
    }

    .player-stats {
      background: rgba(0,0,0,0.6);
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #FFD700;
    }

    .gold {
      color: #FFD700;
      font-size: 2em;
      font-weight: bold;
      text-shadow: 0 0 10px #FFD700;
    }

    /* Login */
    .login-screen {
      max-width: 600px;
      margin: 100px auto;
      background: rgba(0, 0, 0, 0.8);
      border: 4px solid #FF8C00;
      border-radius: 20px;
      padding: 50px;
      text-align: center;
      box-shadow: 0 0 50px rgba(255, 140, 0, 0.5);
    }

    .login-screen h1 {
      color: #FFD700;
      font-size: 3.5em;
      margin-bottom: 20px;
      text-shadow: 0 0 30px #FF8C00;
    }

    .login-screen input {
      width: 100%;
      padding: 20px;
      font-size: 1.5em;
      border: 3px solid #FF8C00;
      border-radius: 10px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      background: rgba(0,0,0,0.5);
      color: #fff;
    }

    /* World Map */
    .world-map {
      display: flex;
      flex-direction: column;
      gap: 40px;
      margin: 40px 0;
      position: relative;
    }

    .region {
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.4), rgba(101, 67, 33, 0.4));
      border: 4px solid #654321;
      border-radius: 20px;
      padding: 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .region:hover {
      transform: scale(1.02);
      border-color: #FFD700;
      box-shadow: 0 0 40px rgba(255, 215, 0, 0.5);
    }

    .region.locked {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .region.locked::after {
      content: 'üîí';
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 3em;
    }

    .region-info h2 {
      color: #FFD700;
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .region-stats {
      display: flex;
      gap: 30px;
      margin-top: 15px;
    }

    .stat {
      background: rgba(0,0,0,0.5);
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1.1em;
    }

    /* Lobby */
    .lobby {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      margin: 20px 0;
    }

    .lobby-main {
      background: rgba(0,0,0,0.6);
      border: 3px solid #FF8C00;
      border-radius: 15px;
      padding: 30px;
    }

    .lobby-players {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin: 30px 0;
    }

    .player-slot {
      background: rgba(139, 69, 19, 0.3);
      border: 2px solid #654321;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .player-slot.filled {
      border-color: #32CD32;
      background: rgba(50, 205, 50, 0.2);
    }

    .player-slot.ready {
      border-color: #FFD700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    .chat {
      background: rgba(0,0,0,0.6);
      border: 3px solid #FF8C00;
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 600px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
      padding: 10px;
    }

    .chat-message {
      background: rgba(139, 69, 19, 0.3);
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
      border-left: 3px solid #FFD700;
    }

    .chat-input {
      display: flex;
      gap: 10px;
    }

    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 2px solid #654321;
      border-radius: 8px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-family: 'Courier New', monospace;
    }

    /* Race Canvas */
    canvas {
      background: linear-gradient(to bottom, #87CEEB 0%, #F4A460 40%, #D2691E 100%);
      border: 4px solid #FF8C00;
      border-radius: 15px;
      display: block;
      margin: 20px auto;
      box-shadow: 0 0 40px rgba(255, 140, 0, 0.5);
    }

    /* Buttons */
    button {
      background: linear-gradient(135deg, #FFD700, #FF8C00);
      color: #000;
      border: none;
      padding: 15px 30px;
      font-size: 1.2em;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(255, 140, 0, 0.4);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(255, 140, 0, 0.6);
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }

    .back-button {
      background: linear-gradient(135deg, #666, #444);
    }

    /* Position Tracker */
    .position-tracker {
      background: rgba(0,0,0,0.8);
      border: 3px solid #FFD700;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .position-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      margin: 5px 0;
      background: rgba(139, 69, 19, 0.3);
      border-radius: 8px;
    }

    .position-item.player {
      border: 2px solid #32CD32;
      background: rgba(50, 205, 50, 0.2);
    }

    .game-screen { display: none; }
    .game-screen.active { display: block; }

    /* Animations */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .ready-pulse {
      animation: pulse 1s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-screen">
      <h1>üèúÔ∏è DUNE RUSH</h1>
      <p style="color: #FF8C00; font-size: 1.5em; margin: 20px 0;">MULTIPLAYER RACING MMORPG</p>
      <input type="text" id="playerName" placeholder="Enter your racer name..." maxlength="20">
      <button onclick="login()" style="width: 100%; padding: 25px;">üèÅ START RACING</button>
      <p style="color: #aaa; margin-top: 30px; font-size: 0.9em;">Race ‚Ä¢ Bet ‚Ä¢ Compete ‚Ä¢ Dominate</p>
    </div>

    <!-- MAIN GAME -->
    <div id="mainGame" style="display: none;">
      <!-- HEADER -->
      <div class="header">
        <div class="title">
          <h1>üèúÔ∏è DUNE RUSH</h1>
          <p style="color: #FF8C00; font-size: 0.8em;">Multiplayer Racing MMORPG</p>
        </div>
        <div class="player-stats">
          <div style="color: #FFD700; font-size: 1.3em; margin-bottom: 5px;">
            <span id="playerNameDisplay"></span>
          </div>
          <div class="gold">üí∞ <span id="goldDisplay">1000</span>G</div>
          <div style="color: #aaa; font-size: 0.9em; margin-top: 5px;">
            Rank: <span id="rankDisplay">Bronze</span> |
            Wins: <span id="winsDisplay">0</span>
          </div>
        </div>
      </div>

      <!-- WORLD MAP SCREEN -->
      <div id="screen-map" class="game-screen active">
        <h2 style="color: #FFD700; font-size: 3em; text-align: center; margin-bottom: 40px;">
          üó∫Ô∏è SELECT YOUR REGION üó∫Ô∏è
        </h2>

        <div class="world-map">
          <div class="region" onclick="enterRegion('bronze')">
            <div class="region-info">
              <h2>üèúÔ∏è BRONZE DUNES</h2>
              <p style="color: #aaa; font-size: 1.2em;">Starter Region</p>
              <div class="region-stats">
                <div class="stat">üí∞ Buy-in: 100 Gold</div>
                <div class="stat">üèÅ Race Length: 3000m</div>
                <div class="stat">üë• Players: <span id="bronze-players">0</span></div>
              </div>
            </div>
            <div style="font-size: 5em;">üê™</div>
          </div>

          <div class="region locked" id="region-pyramid">
            <div class="region-info">
              <h2>üèõÔ∏è PYRAMID VALLEY</h2>
              <p style="color: #aaa; font-size: 1.2em;">Win 3 Bronze races to unlock</p>
              <div class="region-stats">
                <div class="stat">üí∞ Buy-in: 500 Gold</div>
                <div class="stat">üèÅ Race Length: 5000m</div>
                <div class="stat">üë• Players: 0</div>
              </div>
            </div>
            <div style="font-size: 5em;">üèõÔ∏è</div>
          </div>

          <div class="region locked" id="region-sunset">
            <div class="region-info">
              <h2>üåÖ SUNSET MESA</h2>
              <p style="color: #aaa; font-size: 1.2em;">Win 5 Pyramid races to unlock</p>
              <div class="region-stats">
                <div class="stat">üí∞ Buy-in: 1000 Gold</div>
                <div class="stat">üèÅ Race Length: 8000m</div>
                <div class="stat">üë• Players: 0</div>
              </div>
            </div>
            <div style="font-size: 5em;">üåÖ</div>
          </div>

          <div class="region locked" id="region-storm">
            <div class="region-info">
              <h2>‚ö° STORM WASTES</h2>
              <p style="color: #aaa; font-size: 1.2em;">Win 10 Mesa races to unlock</p>
              <div class="region-stats">
                <div class="stat">üí∞ Buy-in: 2500 Gold</div>
                <div class="stat">üèÅ Race Length: 12000m</div>
                <div class="stat">üë• Players: 0</div>
              </div>
            </div>
            <div style="font-size: 5em;">‚ö°</div>
          </div>

          <div class="region locked" id="region-kings">
            <div class="region-info">
              <h2>üëë KING'S OASIS</h2>
              <p style="color: #aaa; font-size: 1.2em;">Win 20 Storm races to unlock</p>
              <div class="region-stats">
                <div class="stat">üí∞ Buy-in: 5000 Gold</div>
                <div class="stat">üèÅ Race Length: 20000m</div>
                <div class="stat">üë• Players: 0</div>
              </div>
            </div>
            <div style="font-size: 5em;">üëë</div>
          </div>
        </div>
      </div>

      <!-- LOBBY SCREEN -->
      <div id="screen-lobby" class="game-screen">
        <button class="back-button" onclick="returnToMap()">‚Üê Back to Map</button>
        <h2 style="text-align: center; margin-bottom: 30px;">
          üèÅ RACE LOBBY - <span id="lobbyRegion">Bronze Dunes</span>
        </h2>

        <div class="lobby">
          <div class="lobby-main">
            <h3 style="color: #FFD700; font-size: 1.8em; margin-bottom: 20px;">
              Waiting for Players... (<span id="playerCount">1</span>/8)
            </h3>

            <div class="lobby-players" id="lobbyPlayers">
              <!-- Player slots filled by JS -->
            </div>

            <div style="text-align: center; margin-top: 30px;">
              <button id="readyBtn" onclick="toggleReady()" style="font-size: 1.5em; padding: 20px 60px;">
                ‚è±Ô∏è READY UP
              </button>
              <p style="color: #aaa; margin-top: 15px;">
                Race starts when all players are ready!
              </p>
            </div>
          </div>

          <div class="chat">
            <h3 style="color: #FFD700; margin-bottom: 15px;">üí¨ CHAT</h3>
            <div class="chat-messages" id="chatMessages">
              <div class="chat-message">
                <strong style="color: #FFD700;">System:</strong> Welcome to the lobby!
              </div>
            </div>
            <div class="chat-input">
              <input type="text" id="chatInput" placeholder="Say something..." maxlength="100">
              <button onclick="sendChat()">üì§</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RACE SCREEN -->
      <div id="screen-race" class="game-screen">
        <h2 style="text-align: center; margin-bottom: 20px;">
          üèÅ RACE IN PROGRESS üèÅ
        </h2>

        <div class="position-tracker">
          <h3 style="color: #FFD700; text-align: center; margin-bottom: 15px;">LIVE POSITIONS</h3>
          <div id="positionList"></div>
        </div>

        <canvas id="raceCanvas" width="1600" height="800"></canvas>

        <div id="raceResult" style="text-align: center; margin-top: 30px; display: none;">
          <h2 style="color: #FFD700; font-size: 3em; margin-bottom: 20px;">RACE COMPLETE!</h2>
          <p id="resultText" style="font-size: 1.8em; margin-bottom: 30px;"></p>
          <button onclick="returnToMap()" style="padding: 20px 60px; font-size: 1.5em;">
            üó∫Ô∏è BACK TO MAP
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Note: This is a demo version. Supabase tables need to be created:
    // - players (id, name, gold, total_wins)
    // - lobbies (id, region, status, player_count)
    // - lobby_players (id, lobby_id, player_id, player_name, ready)
    // - race_participants (id, lobby_id, player_id, player_name, camel_id, camel_name, position)
    // - chat_messages (id, lobby_id, player_name, message, created_at)

    const SUPABASE_URL = "https://itxbzfwtutozegelbwwt.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0eGJ6Znd0dXRvemVnZWxid3d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDg2NDcsImV4cCI6MjA3ODMyNDY0N30._1Oy-uaTvFxusKiooj2Pta7rYp_EOkor9wnfWQfWe7I";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // GAME STATE
    const GameState = {
      playerName: null,
      playerId: null,
      gold: 1000,
      wins: 0,
      rank: 'Bronze',
      currentRegion: null
    };

    // CAMELS
    const CAMELS = [
      { id: 0, name: 'Desert Storm', baseSpeed: 2.8, color: '#8B4513', jockey: 'üë≥' },
      { id: 1, name: 'Sand Runner', baseSpeed: 2.5, color: '#D2691E', jockey: 'üßî' },
      { id: 2, name: 'Golden Wind', baseSpeed: 3.0, color: '#DAA520', jockey: 'üë®' },
      { id: 3, name: 'Oasis King', baseSpeed: 2.6, color: '#CD853F', jockey: 'üßë' },
      { id: 4, name: 'Dune Dancer', baseSpeed: 2.9, color: '#DEB887', jockey: 'üë¥' },
      { id: 5, name: 'Mirage Master', baseSpeed: 3.1, color: '#F4A460', jockey: 'üßì' },
      { id: 6, name: 'Swift Sands', baseSpeed: 2.7, color: '#BC8F8F', jockey: 'üë≤' },
      { id: 7, name: 'Thunder Hoof', baseSpeed: 2.4, color: '#A0522D', jockey: 'üßï' },
      { id: 8, name: 'Lightning Bolt', baseSpeed: 3.2, color: '#D2B48C', jockey: 'üë±' }
    ];

    // REGIONS CONFIG
    const REGIONS = {
      bronze: { name: 'Bronze Dunes', buyin: 100, length: 3000, emoji: 'üèúÔ∏è' },
      pyramid: { name: 'Pyramid Valley', buyin: 500, length: 5000, emoji: 'üèõÔ∏è' },
      sunset: { name: 'Sunset Mesa', buyin: 1000, length: 8000, emoji: 'üåÖ' },
      storm: { name: 'Storm Wastes', buyin: 2500, length: 12000, emoji: '‚ö°' },
      kings: { name: "King's Oasis", buyin: 5000, length: 20000, emoji: 'üëë' }
    };

    // LOGIN
    function login() {
      const name = document.getElementById('playerName').value.trim();
      if (!name) {
        alert('Enter a racer name!');
        return;
      }

      GameState.playerName = name;
      GameState.playerId = 'player_' + Math.random().toString(36).substr(2, 9);

      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainGame').style.display = 'block';
      updatePlayerDisplay();
    }

    // ENTER REGION (Simplified demo version)
    function enterRegion(region) {
      const config = REGIONS[region];

      if (GameState.gold < config.buyin) {
        alert(`Need ${config.buyin} gold to enter!`);
        return;
      }

      GameState.currentRegion = region;
      GameState.gold -= config.buyin;
      updatePlayerDisplay();

      // Go straight to race for demo
      showScreen('race');
      setTimeout(() => RaceEngine.init(region), 500);
    }

    // RACE ENGINE
    const RaceEngine = {
      canvas: null,
      ctx: null,
      region: null,
      camels: [],
      raceInProgress: false,
      raceLength: 3000,

      async init(region) {
        this.region = region;
        this.canvas = document.getElementById('raceCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.raceLength = REGIONS[region].length;

        // Setup 9 AI racers
        this.camels = CAMELS.map((camel, i) => ({
          ...camel,
          playerName: i === 0 ? GameState.playerName : `Racer ${i}`,
          isPlayer: i === 0,
          x: 50,
          y: 200 + (Math.random() * 400),
          speed: camel.baseSpeed,
          stamina: 100,
          distance: 0
        }));

        this.drawTrack();

        // Countdown
        await this.countdown();
        this.startRace();
      },

      async countdown() {
        for (let i = 3; i > 0; i--) {
          this.ctx.fillStyle = 'rgba(0,0,0,0.7)';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          this.ctx.fillStyle = '#FFD700';
          this.ctx.font = 'bold 200px Courier';
          this.ctx.textAlign = 'center';
          this.ctx.fillText(i, this.canvas.width / 2, this.canvas.height / 2);
          await new Promise(r => setTimeout(r, 1000));
        }
      },

      drawTrack() {
        const ctx = this.ctx;
        const canvas = this.canvas;

        // Sky
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height * 0.3);
        gradient.addColorStop(0, '#87CEEB');
        gradient.addColorStop(1, '#F4A460');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height * 0.3);

        // Sand dunes
        ctx.fillStyle = '#F4A460';
        ctx.beginPath();
        ctx.moveTo(0, canvas.height * 0.3);
        for (let x = 0; x < canvas.width; x += 20) {
          const y = canvas.height * 0.3 + Math.sin(x * 0.02) * 40 + 80;
          ctx.lineTo(x, y);
        }
        ctx.lineTo(canvas.width, canvas.height);
        ctx.lineTo(0, canvas.height);
        ctx.fill();

        // Darker dunes
        ctx.fillStyle = '#D2691E';
        ctx.beginPath();
        ctx.moveTo(0, canvas.height * 0.6);
        for (let x = 0; x < canvas.width; x += 20) {
          const y = canvas.height * 0.6 + Math.sin(x * 0.03 + 2) * 30 + 50;
          ctx.lineTo(x, y);
        }
        ctx.lineTo(canvas.width, canvas.height);
        ctx.lineTo(0, canvas.height);
        ctx.fill();

        // Sun
        ctx.fillStyle = '#FFD700';
        ctx.beginPath();
        ctx.arc(150, 100, 60, 0, Math.PI * 2);
        ctx.fill();
      },

      drawCamel(camel) {
        const ctx = this.ctx;

        // Camel body
        ctx.fillStyle = camel.color;
        ctx.fillRect(camel.x, camel.y, 60, 40);
        ctx.fillRect(camel.x + 50, camel.y - 20, 20, 30);

        // Humps
        ctx.beginPath();
        ctx.arc(camel.x + 20, camel.y + 5, 15, Math.PI, 0);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(camel.x + 40, camel.y + 5, 12, Math.PI, 0);
        ctx.fill();

        // Legs
        ctx.fillRect(camel.x + 10, camel.y + 40, 6, 20);
        ctx.fillRect(camel.x + 25, camel.y + 40, 6, 20);
        ctx.fillRect(camel.x + 40, camel.y + 40, 6, 20);
        ctx.fillRect(camel.x + 55, camel.y + 40, 6, 20);

        // Jockey
        ctx.font = '30px Arial';
        ctx.fillText(camel.jockey, camel.x + 25, camel.y + 20);

        // Player name
        ctx.fillStyle = camel.isPlayer ? '#32CD32' : '#000';
        ctx.font = 'bold 12px Courier';
        ctx.fillText(camel.playerName, camel.x, camel.y - 30);

        // Progress indicator
        if (camel.isPlayer) {
          ctx.strokeStyle = '#32CD32';
          ctx.lineWidth = 3;
          ctx.strokeRect(camel.x - 5, camel.y - 35, 70, 100);
        }
      },

      startRace() {
        this.raceInProgress = true;
        this.animate();
      },

      animate() {
        if (!this.raceInProgress) return;

        this.drawTrack();

        let raceFinished = false;
        let winner = null;

        this.camels.forEach(camel => {
          // Speed calculation
          camel.speed = camel.baseSpeed + (Math.random() - 0.5) * 1.2;

          // Stamina
          camel.stamina -= 0.08;
          if (camel.stamina < 70) camel.speed *= 0.97;
          if (camel.stamina < 40) camel.speed *= 0.93;
          if (camel.stamina < 20) camel.speed *= 0.88;

          // Random bursts
          if (Math.random() > 0.98) camel.speed *= 1.5;

          // Movement
          camel.distance += camel.speed;
          camel.x = 50 + (camel.distance / this.raceLength) * (this.canvas.width - 200);
          camel.y += (Math.random() - 0.5) * 3;
          camel.y = Math.max(200, Math.min(600, camel.y));

          this.drawCamel(camel);

          // Check finish
          if (camel.distance >= this.raceLength && !winner) {
            winner = camel;
            raceFinished = true;
          }
        });

        // Update position tracker
        this.updatePositions();

        if (raceFinished) {
          this.finishRace(winner);
        } else {
          requestAnimationFrame(() => this.animate());
        }
      },

      updatePositions() {
        const sorted = [...this.camels].sort((a, b) => b.distance - a.distance);
        const div = document.getElementById('positionList');

        div.innerHTML = sorted.map((camel, i) => {
          const progress = ((camel.distance / this.raceLength) * 100).toFixed(1);

          return `
            <div class="position-item ${camel.isPlayer ? 'player' : ''}">
              <div>
                <span style="font-size: 1.3em; margin-right: 10px;">
                  ${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i+1}.`}
                </span>
                <strong>${camel.playerName}</strong>
              </div>
              <div style="color: #FFD700;">${progress}%</div>
            </div>
          `;
        }).join('');
      },

      finishRace(winner) {
        this.raceInProgress = false;

        // Calculate positions and payouts
        const sorted = [...this.camels].sort((a, b) => b.distance - a.distance);
        const buyin = REGIONS[this.region].buyin;
        const prize = buyin * 9;

        // Payouts: 1st: 60%, 2nd: 25%, 3rd: 15%
        const payouts = [
          Math.floor(prize * 0.6),
          Math.floor(prize * 0.25),
          Math.floor(prize * 0.15)
        ];

        const playerPosition = sorted.findIndex(c => c.isPlayer);
        let resultMsg = '';

        if (playerPosition === 0) {
          GameState.gold += payouts[0];
          GameState.wins++;
          resultMsg = `üèÜ YOU WON! +${payouts[0]} GOLD! üèÜ`;
        } else if (playerPosition === 1) {
          GameState.gold += payouts[1];
          resultMsg = `ü•à 2nd Place! +${payouts[1]} GOLD`;
        } else if (playerPosition === 2) {
          GameState.gold += payouts[2];
          resultMsg = `ü•â 3rd Place! +${payouts[2]} GOLD`;
        } else {
          resultMsg = `Position ${playerPosition + 1}. Better luck next time!`;
        }

        document.getElementById('resultText').textContent = resultMsg;
        document.getElementById('raceResult').style.display = 'block';
        updatePlayerDisplay();
      }
    };

    // NAVIGATION
    function showScreen(name) {
      document.querySelectorAll('.game-screen').forEach(s => s.classList.remove('active'));
      document.getElementById(`screen-${name}`).classList.add('active');
    }

    function returnToMap() {
      showScreen('map');
      document.getElementById('raceResult').style.display = 'none';
    }

    function updatePlayerDisplay() {
      document.getElementById('playerNameDisplay').textContent = GameState.playerName;
      document.getElementById('goldDisplay').textContent = GameState.gold;
      document.getElementById('winsDisplay').textContent = GameState.wins;
      document.getElementById('rankDisplay').textContent = GameState.rank;
    }

    // Stub functions for demo
    function toggleReady() { alert('Lobby system requires Supabase tables to be set up!'); }
    function sendChat() { alert('Chat requires Supabase tables to be set up!'); }
  </script>
</body>
</html>
